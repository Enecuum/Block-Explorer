<template>
  <b-container fluid class="container-wrapper">

    <b-row class="m-0 mb-20 pb-20 border-bottom-gray">

      <b-col class="d-flex pr-0 pl-0 align-items-center justify-content-center">
        <svg class="mr-2" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="26px" height="30px" version="1.1" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 1400273 1662572">
                   <g>
                    <g>
                     <path fill="#00ADD9" d="M1400273 160409c0,88609 -71833,160442 -160442,160442 -88609,0 -160442,-71833 -160442,-160442 0,-88576 71833,-160409 160442,-160409 88609,0 160442,71833 160442,160409z"/>
                     <path fill="white" fill-rule="nonzero" d="M1267659 78324c0,15345 -12483,27827 -27828,27827 -15345,0 -27828,-12482 -27828,-27827l0 -2896c0,-15345 12483,-27828 27828,-27828 15345,0 27828,12483 27828,27828l0 2896zm-34 173823c0,17442 -12449,31589 -27794,31589 -15345,0 -27795,-14147 -27795,-31589l0 -91772c0,-17442 12450,-31589 27795,-31589 15345,0 27794,14147 27794,31589l0 91772z"/>
                     <path fill="#00ADD9" fill-rule="nonzero" d="M1289927 632315c27562,0 49931,22368 49931,49930 0,27561 -22369,49930 -49931,49930l-1119499 0 223421 223420c19472,19473 19472,51096 0,70568 -19473,19473 -51096,19473 -70568,0l-307503 -307502 -300 -267 -166 -166 -433 -433 -266 -233 -167 -200 -432 -466 -233 -199 -200 -233 -433 -466 -166 -200 -266 -266 -400 -466 -133 -167 -266 -299 -433 -500 -67 -100 -299 -366 -400 -499 -66 -67 -333 -432 -366 -500 -34 -33 -332 -466 -367 -499 -366 -500 -333 -499 -33 -33 -333 -533 -299 -432 -34 -67 -332 -533 -267 -399 -66 -133 -333 -566 -200 -366 -100 -167 -333 -532 -166 -333 -133 -233 -267 -566 -166 -266 -133 -300 -266 -566 -134 -233 -166 -333 -266 -566 -67 -199 -200 -366 -233 -600 -66 -133 -167 -432 -266 -600 -33 -99 -200 -500 -200 -566 -33 -66 -200 -533 -199 -599 0 -33 -200 -599 -200 -566 0 -34 -166 -599 -167 -566 -33 -66 -166 -599 -134 -500 -33 -133 -133 -632 -133 -433 -33 -200 -134 -632 -99 -400 -34 -233 -133 -632 -66 -366 -34 -266 -100 -633 -66 -333 -33 -333 -100 -632 -34 -266 -33 -400 -100 -632 0 -233 -66 -433 -34 -666 -33 -166 -33 -499 -33 -666 0 -100 -34 -566 0 -666 -33 -33 0 -632 0 -666 0 -666 0 -632 33 -34 0 -665 34 -566 0 -100 33 -666 33 -499 33 -167 34 -665 66 -433 0 -233 100 -632 33 -400 34 -266 100 -633 33 -333 66 -332 100 -633 34 -266 66 -366 133 -633 34 -233 99 -399 134 -633 33 -199 133 -433 133 -633 33 -133 134 -499 166 -599 33 -67 167 -566 166 -599 0 -33 200 -566 200 -599 0 -33 199 -600 200 -532 33 -67 200 -566 200 -499 33 -100 266 -599 167 -433 66 -133 233 -599 200 -366 67 -200 266 -566 166 -333 134 -233 266 -565 133 -300 166 -266 267 -566 133 -233 166 -333 333 -533 100 -166 200 -366 333 -566 66 -133 267 -400 332 -532 34 -67 299 -433 333 -532 33 -33 333 -500 366 -499 367 -499 332 -466 34 -34 366 -499 333 -433 66 -66 400 -500 299 -366 67 -100 433 -499 266 -299 133 -167 400 -466 266 -266 166 -200 433 -466 200 -233 233 -200 432 -466 167 -166 266 -266 433 -433 166 -167 300 -266 307503 -307536c19472,-19473 51095,-19473 70568,0 19472,19473 19472,51095 0,70568l-223421 223454 1119499 0zm36949 705279l-1665 1731 -1131 1132 -307503 307503c-19473,19472 -51095,19472 -70568,0 -19473,-19473 -19473,-51096 0,-70568l223420 -223421 -1119499 0c-27561,0 -49930,-22369 -49930,-49930 0,-27561 22369,-49930 49930,-49930l1119499 0 -223420 -223454c-19473,-19473 -19473,-51095 0,-70568 19473,-19473 51095,-19473 70568,0l307503 307536 299 267 167 166 432 433 267 266 166 167 433 466 233 199 200 233 432 466 167 200 266 266 399 466 134 167 266 299 433 500 66 99 300 367 399 499 67 66 333 433 366 500 33 33 333 466 366 499 366 499 333 500 33 33 333 533 300 432 33 67 333 532 266 400 67 133 333 566 199 366 100 167 333 532 167 333 133 233 266 566 167 266 133 300 266 566 133 233 167 333 266 565 66 200 200 366 233 599 67 134 166 432 266 599 34 100 199 500 200 565 33 67 200 533 200 599 0 33 200 599 199 566 0 33 167 600 166 565 33 67 167 599 133 499 33 134 133 632 134 433 33 200 133 632 100 399 33 233 133 633 67 366 33 266 100 633 67 333 33 333 100 632 33 266 33 400 100 632 0 233 67 433 33 666 33 166 34 499 33 666 0 100 33 566 0 666 34 33 0 632 0 666 0 1298 -67 1265 -67 1265 -133 1265 -133 1265 -166 1231 -200 1232 -233 1232 -266 1231 -300 1199 -333 1165 -333 1198 -399 1165 -400 1165 -432 1132 -466 1131 -500 1099 -499 1098 -532 1099 -566 1065 -600 1032 -299 532 -300 500 0 33 -333 499 -299 500 -33 0 -300 499 -333 499 -699 999 -699 965 -732 966 -766 932 -765 898 -799 899z"/>
                    </g>
                   </g>
                  </svg>
        <h1 class="weight-600 m-0">
          Send Transaction
        </h1>
      </b-col>

    </b-row>

    <b-row class="mt-20">
      <b-col>

        <b-form>

          <b-row>
            <b-col cols="12" md="1" class="font-14 weight-600 d-flex align-items-center">
              Owner:
            </b-col>

            <b-col cols="12" md="11">
                <b-input readonly v-model="owner.public"  class="transaction border-radius-right-0"></b-input>
            </b-col>
          </b-row>

          <b-row class="mt-10">
            <b-col cols="12" md="1" class="font-14 weight-600 d-flex align-items-center">
              Private:
            </b-col>

            <b-col cols="12" md="11">
              <b-input readonly v-model="owner.private"  class="transaction border-radius-right-0"></b-input>
            </b-col>
          </b-row>

          <b-row class="mt-10">
            <b-col cols="12" md="1" class="font-14  weight-600 d-flex align-items-center">
              Receiver:
            </b-col>

            <b-col cols="12" md="11">
              <b-input v-model="receiver" placeholder="0xjNds..." class="transaction" :class="{'error': error.receiver}"></b-input>
            </b-col>
          </b-row>

          <b-row class="mt-1" v-if="error.receiver">
            <b-col offset="1">
              <span class="text-danger">Receiver must be base58 and at least 41 characters long and no more than 45 </span>
            </b-col>
          </b-row>

          <b-row class="mt-10">
            <b-col cols="12" md="1" class="font-14 weight-600 d-flex align-items-center">
              Amount:
            </b-col>

            <b-col cols="12" md="11">
              <b-form-input v-model="amount" placeholder="100" class="transaction" :class="{'error': error.amount}"></b-form-input>
            </b-col>
          </b-row>

          <b-row class="mt-1" v-if="error.amount ">
            <b-col offset="1">
              <span class="text-danger">Amount must be an integer, greater than 0 and no more than 100</span>
            </b-col>
          </b-row>

          <b-row class="mt-20">
            <b-col class="d-flex justify-content-center">
              <b-btn @click="sendTransaction" class="transaction-button font-14 weight-600">
                Send transaction
              </b-btn>
              <b-btn @click="$refs.wallet.show()" class="transaction-button font-14 weight-600 ml-3">
                Change wallet
              </b-btn>
            </b-col>
          </b-row>

          <!--<b-row class="mt-20 font-14 weight-600" v-if="this.items.length">-->
            <!--<b-col>-->

            <!--<b-table striped hover responsive :items="this.items" :fields="fields">-->

              <!--<template slot="hash" slot-scope="data">-->
                <!--<router-link class="href td-hash-wrapper" :to="{name: 'Transaction', params: { id: data.item.hash }}">-->
                  <!--{{ data.item.hash }}-->
                <!--</router-link>-->
              <!--</template>-->

              <!--<template slot="owner" slot-scope="data">-->
                <!--<router-link class="href td-hash-wrapper" :to="{name: 'Wallet', params: { id: data.item.owner }}">-->
                  <!--{{ encodeURIComponent(data.item.owner) }}-->
                <!--</router-link>-->
              <!--</template>-->

              <!--<template slot="receiver" slot-scope="data">-->
                <!--<router-link class="href td-hash-wrapper" :to="{name: 'Wallet', params: { id: data.item.receiver }}">-->
                  <!--{{ encodeURIComponent(data.item.receiver) }}-->
                <!--</router-link>-->
              <!--</template>-->

              <!--<template slot="amount" slot-scope="data">-->
                <!--{{data.item.amount}} {{data.item.currency}}-->
              <!--</template>-->

            <!--</b-table>-->

            <!--</b-col>-->
          <!--</b-row>-->

          <b-modal ref="wallet"
                   @ok="handleOk"
                  no-close-on-esc
                  no-close-on-backdrop
                  hide-header-close
                  size="lg">
            <template slot="modal-header">
                <span class="font-18 weight-600">Wallet</span>
            </template>

            <template slot="modal-footer">
              <b-btn @click="handleOk" class="transaction-button font-14 weight-600">
                ОК
              </b-btn>
            </template>
            <p class="mt-20">
              We do not store your key on the server. The key generation is handled on your browser only.
              <br>
              <br>
              Back up your key if you want to reuse in the future. If you lose your key, it cannot be recovered.
            </p>
              <div class="d-flex mb-20">
                <b-input v-model="owner.public" class="transaction border-radius-right-0"></b-input>
                <b-btn @click="generateTx" class="transaction-button font-14 weight-600 border-radius-left-0">
                  Generate
                </b-btn>
              </div>
          </b-modal>

        </b-form>

      </b-col>
    </b-row>

  </b-container>
</template>

<script>
  const bs = require("bs58")
  const EC = require("elliptic").ec
  const ec = new EC("secp256k1")

  export default {
    name: "sendTransaction",
    data() {
      return {
        owner: {
          public: window.localStorage.public || "",
          private: window.localStorage.private || ""
        },
        receiver: "",
        amount: "",
        currency: "ENQ",
        uuid: _.random(1, 100),
        sign: {
          sign_s:"",
          sign_r:""
        },
        timestamp: "",
        // items:[],
        // fields: [
        //   {key: 'hash', label: 'Hash', tdClass: 'weight-600'},
        //   {key: 'owner', label: 'From', tdClass: 'weight-600'},
        //   {key: 'receiver', label: 'To', tdClass: 'weight-600'},
        //   {key: 'amount', label: 'Amount', tdClass: 'weight-600'}
        // ],
        error: {
          amount: false,
          receiver: false
        }
      }
    },
    watch: {
      amount: function(val) {
        if (this.error.amount) this.validation()
      },
      receiver: function(val) {
        if (this.error.receiver) this.validation()
      }
    },
    methods: {
      handleOk(e){
        e.preventDefault()
        if (this.owner.public === ""){
          alert("please enter your key")
        } else if (this.owner.public.length < 41){
          alert("Key must be base58 and at least 41 characters long")
        } else {
            this.$refs.wallet.hide()
        }
      },

      generateTx() {
        const key = ec.genKeyPair()
        let publicKey = key.getPublic().encodeCompressed()
        let privateKey = key.getPrivate().toString("hex")

        this.owner.public = bs.encode(publicKey)
        this.owner.private = privateKey

        window.localStorage.setItem("public", this.owner.public)
        window.localStorage.setItem("private", this.owner.private)
      },

      sendTransaction() {
        if (this.validation()) return

        let key = ec.keyPair({
          priv: this.owner.private,
          privEnc: "hex",
          pub: bs.decode(this.owner.public)
        })

        this.timestamp = new Date().valueOf()

        let msg = {
          tx: {
            owner: this.owner.public,
            receiver: this.receiver,
            amount: this.amount,
            currency: this.currency,
            uuid: this.uuid,
            timestamp: this.timestamp
          }
        }

        let message = Buffer.from(JSON.stringify(msg))
        let signature = key.sign(message)

        console.log(signature)


        return


        let params = {
          tx: {
            owner: this.owner.public,
            receiver: this.receiver,
            amount: this.amount,
            currency: this.currency,
            uuid: this.uuid,
            sign: {
              sign_s: this.sign.sign_s,
              sign_r: this.sign.sign_r
            },
            timestamp: this.timestamp
          }
        }

        this.$root.ws.call("sendTransaction", params).then((response) =>
        {
          if (response) {
            this.receiver = ""
            this.amount = ""
            alert("Transaction successfully sent")
          }
        }).catch(error => alert("error"))
        // then((response) =>
        // {
        //   params.tx.hash = response
        //   this.items.push(params.tx)
        // })
      },

      validation() {
        if (!this.receiver || !this.amount) {
          alert("you did not fill out the required fields")
          return true
        }

        let reg = /^\w{41,45}$/
        if(reg.test(this.receiver)) {
          this.error.receiver = false
        } else {
          this.error.receiver = true
          return true
        }

        reg = /\D+/
        if (reg.test(this.amount) || this.amount > 100 || this.amount < 1) {
          this.error.amount = true
          return true
        } else {
          this.error.amount = false
        }

        return false
      }
    },
    mounted() {
     if (!window.localStorage.public) this.$refs.wallet.show()
    }
  }
</script>
